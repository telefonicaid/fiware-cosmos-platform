Module osn
{

	title	"OSN_data analysis  module"
	author 	"Gregorio Escalada (jges@tid.es)"
	version "0.1"
	
}

# ---------------------------------------------------------------------------
# datas
# ---------------------------------------------------------------------------

data URL
{
     system.String completeURL;
     system.String url_host;
     system.String url_dir;
     system.String url_page;
     system.String url_query;
     system.String url_locDoc;
}

data URLConnection
{
	system.UInt64 msisdn;
	osn.URL url;
	system.Date date;
	system.Time time;
	system.UInt16 status;
	system.String MIMEcontent;
	system.String userAgent;
	system.UInt8 method;
}

data Count
{
	system.UInt count;
	system.String element;
}
 
data CountF
{
	system.Float count;
	system.String element;
}
 
# -------------------------------------------------
# Operations with urls
# -------------------------------------------------

parser parse_urls
{
	out system.UInt64 osn.URLConnection	
	
	helpLine "Parse web connections in txt format producing a single key-value at the output per each valid conection (output: system.UInt osn.URLConnection)"

	help
	{
		"parse txt-file of web connections from O2UK."
		"The txt-file must have already been uploaded"
		"The fields (separator is tab character) of the web connections text file, "
		"according to the documentation provided by Graham Hargreaves, are:"
		"1.- Unique ID, msisdn"
		"2.- URL"
		"3.- Event Date/Timestamp"
		"4.- Status code"
		"5.- Content type"
		"6.- User agent"
		"7.- HTTP access method"
	}
}

map map_urls_to_kv_to_compute_sites_visited
{
	in system.UInt64 osn.URLConnection	
	out system.String system.UInt	
	out system.UInt system.UInt	

	helpLine "Emits sites visited by iphone user agents (or iphone application) as key, and the number of occurences as value"

	help
	{
		"maps the input of web connections by iphone user agents (or iphone application) to key-values in order to compute the count of sites visited"
	}	
}

map map_site_user
{
	in system.UInt64 osn.URLConnection	
	out system.String system.UInt	
	out system.UInt system.UInt	

	helpLine "Emits URLs from search.yahoo.com (config), visited by iphone user agent (config), as key, and the number of occurences as value"

	help
	{
		"maps the input of URLs from search.yahoo.com (config), visited by iphone user agent (config), to key-values in order to compute the count of sites visited"
		"The environment variable to select user agent is 'osn.user_agent_query'"
		"The environment variable to select domain is 'osn.domain_query'"
	}	
}

map map_url_user
{
	in system.UInt64 osn.URLConnection	
	out system.String system.UInt	
	out system.UInt system.UInt	

	helpLine "Emits URLs from search.yahoo.com (config), visited by iphone user agent (config), as key, and the number of occurences as value"

	help
	{
		"maps the input of URLs from search.yahoo.com (config), visited by iphone user agent (config), to key-values in order to compute the count of sites visited"
		"The environment variable to select user agent is 'osn.user_agent_query'"
		"The environment variable to select domain is 'osn.locDoc_query'"
	}	
}

map map_urls_by_hour
{
	in system.UInt64 osn.URLConnection	
	out system.String system.UInt	
	out system.UInt system.UInt	

	helpLine "Emits URLs as values with hour slot as key"

	help
	{
		"Emits URLs as values with hour slot as key"
	}	
}

map map_applications
{
	in system.UInt64 osn.URLConnection	
	out system.String system.UInt	
	out system.String system.UInt	
	out system.UInt system.UInt	

	helpLine "Emits user_agent logs with Apple applications (Weather, Stocks, Maps, iTunes)"

	help
	{
		"Emits user_agent logs with Apple applications (Weather, Stocks, Maps, iTunes)"
	}	
}

map map_extract_logs_by_useragent
{
	in system.UInt64 osn.URLConnection	
	out system.String osn.URLConnection	
	out system.UInt system.UInt	

	helpLine "Emits complete logs with NokiaN95 (config.) userAgent"

	help
	{
		"Emits complete logs with NokiaN95 (config.) userAgent"
		"Selects logs with userAgent field matching de environment variable 'osn.user_agent_query'"
		"The key is the userAgent String, and the value is the complete record"
	}	
}

map map_filter_in_by_status
{
	in system.String osn.URLConnection	
	out system.String osn.URLConnection	
	out system.UInt system.UInt	

	helpLine "Filters in connections by status code (config) (def '404')."

	help
	{
		"Filters in connections by status code (config) (def '404')."
		"environment variable 'osn.status-query'"
	}
}

map map_filter_out_by_status
{
	in system.String osn.URLConnection	
	out system.String osn.URLConnection	
	out system.UInt system.UInt	

	helpLine "Filters out connections by status code (config) (def '404')."

	help
	{
		"Filters out connections by status code (config) (def '404')."
		"environment variable 'osn.status-query'"
	}
}



reduce red_compute_sites_visited
{
	in system.String system.UInt	
	out system.UInt osn.Count

	helpLine "Computes the total account of visits for every domain"

	help
	{
		"Computes the total account of visits for every domain"
		"Emits a Count struct, in order to sort them lately (taking advantage of the ability of SAMSON"
		"to deliver both keys and values sorted"
	}
	
}

reduce red_select_N_sites
{
	in system.UInt osn.Count
	out osn.Count system.Void

	helpLine "Just select the first N most visited sites"

	help
	{
		"Just select the first N most visited sites"
	}
}

reduce red_compute_total_elements
{
	in system.UInt osn.Count
	out system.UInt system.Void

	helpLine "Just accumulates the total count of elements"

	help
	{
		"Just accumulates the total count of elements"
	}
}

reduce red_compute_total_and_set
{
	in system.UInt system.UInt
	out system.UInt system.Void

	helpLine "Just accumulates the total count. Try to export results through environment, but it is not meant for that, so it doesn't work Fake output just to compile with changes in platform"

	help
	{
		"Just accumulates the total count"
		"Andreu confirm that this cannot work, because environment is not meant to pass results between modules"
	}
}

parserOut export_connections
{
	in system.String osn.URLConnection	

	helpLine "Export complete connection log in txt format"
}

parserOut export_report
{
	in system.UInt osn.Count

	helpLine "Export report in txt format"
}

parserOut export_N_sites
{
	in osn.Count system.Void

	helpLine "Export report in txt format"
}

parserOut export_total
{
	in system.UInt system.Void

	helpLine "Export report in txt format"
}

script Bytemobile_req_1
{
	in 	txt txt
	out	txt txt
	out	txt txt

	helpLine "Sequence of operations to compute Reporting Requirements num. 1 (the total number of URLs with iphone agent or iphone application. Out of them the TOPN sites)"

	help
	{
		"Sequence of operations to compute Reporting Requirements num. 1 (the total number of URLs with iphone agent or iphone application. Out of them the TOPN sites)"
	}

	code
	{
		clear $2;
		clear $3;
		
		osn.parse_urls $1 $1.parse -clear -create;
		osn.map_urls_to_kv_to_compute_sites_visited $1.parse $1.p.map $1.total -clear -create;
		osn.red_compute_total_and_set $1.total -clear -create;
		osn.red_compute_sites_visited $1.p.map $1.p.m.red -clear -create;
		osn.export_report $1.p.m.red $2 -clear -create;
		#download $1.p.m.red.txt $2;
		osn.red_select_N_sites $1.p.m.red $1.p.m.red.sort -clear -create;
		osn.export_N_sites $1.p.m.red.sort $3 -clear -create;
		#download $1.p.m.red.sort.txt $3;
	}
}

script Bytemobile_req_2
{
	in 	txt txt
	out	txt txt
	out	txt txt

	helpLine "Sequence of operations to compute Reporting Requirements num. 2 (the total number of URLs with iphone agent and search.yahoo.com"

	help
	{
		"Sequence of operations to compute Reporting Requirements num. 2 (the total number of URLs with iphone agent and search.yahoo.com"
	}

	code
	{
		clear $2;
		clear $3;
		
		osn.parse_urls $1 $1.parse -clear -create;
		set osn.user_agent_query iphone;
		set osn.domain_query search.yahoo.com;
		osn.map_site_user $1.parse $1.p.map $1.total -clear -create;
		osn.red_compute_total_and_set $1.total -clear -create;
		osn.red_compute_sites_visited $1.p.map $1.p.m.red -clear -create;
		osn.export_report $1.p.m.red $2 -clear -create;
		#download $1.p.m.red.txt $2;
		osn.red_compute_total_elements $1.p.m.red $1.p.m.red.total -clear -create;
		#osn.export_total $1.p.m.red.total $3 -clear -create;
		#download $1.p.m.red.total.txt $3;
	}
}

script Bytemobile_req_3
{
	in 	txt txt
	out	txt txt
	out	txt txt

	helpLine "Sequence of operations to compute Reporting Requirements num. 3 (the total number of URLs with iphone agent and www.google.)"

	help
	{
		"Sequence of operations to compute Reporting Requirements num. 3 (the total number of URLs with iphone agent and www.google.)"
	}

	code
	{
		clear $2;
		clear $3;
		
		osn.parse_urls $1 $1.parse -clear -create;
		set osn.user_agent_query iphone;
		set osn.domain_query www.google.;
		osn.map_site_user $1.parse $1.p.map $1.total -clear -create;
		osn.red_compute_total_and_set $1.total -clear -create;
		osn.red_compute_sites_visited $1.p.map $1.p.m.red -clear -create;
		osn.export_report $1.p.m.red $2 -clear -create;
		#download $1.p.m.red.txt $2;
		osn.red_compute_total_elements $1.p.m.red $1.p.m.red.total -clear -create;
		#osn.export_total $1.p.m.red.total $3 -clear -create;
		#download $1.p.m.red.total.txt $3;
	}
}

script Bytemobile_req_4
{
	in 	txt txt
	out	txt txt
	out	txt txt

	helpLine "Sequence of operations to compute Reporting Requirements num. 4 (the search for adult content at Yahoo and Google; to be defined)"

	help
	{
		"Sequence of operations to compute Reporting Requirements num. 4 (the search for adult content at Yahoo and Google; to be defined)"
	}

	code
	{
		clear $2;
		clear $3;
		
	}
}

script Bytemobile_req_5
{
	in 	txt txt
	out	txt txt
	out	txt txt

	helpLine "Sequence of operations to compute Reporting Requirements num. 5 (the total number of hits to O2 bookmark and with iphone agent)"

	help
	{
		"Sequence of operations to compute Reporting Requirements num. 5 (the total number of hits to O2 bookmark and with iphone agent)"
	}

	code
	{
		clear $2;
		clear $3;
		
		osn.parse_urls $1 $1.parse -clear -create;
		set osn.user_agent_query iphone;
		set osn.locDoc_query www.o2.co.uk/iphonestart;
		osn.map_url_user $1.parse $1.p.map $1.total -clear -create;
		osn.red_compute_total_and_set $1.total -clear -create;
		osn.red_compute_sites_visited $1.p.map $1.p.m.red -clear -create;
		osn.export_report $1.p.m.red $2 -clear -create;
		#download $1.p.m.red.txt $2;
		osn.red_compute_total_elements $1.p.m.red $1.p.m.red.total -clear -create;
		#osn.export_total $1.p.m.red.total $3 -clear -create;
		#download $1.p.m.red.total.txt $3;
	}
}

script Bytemobile_req_6
{
	in 	txt txt
	out	txt txt
	out	txt txt

	helpLine "Sequence of operations to compute Reporting Requirements num. 6 (the total number of hits to O2 lower level bookmark and with iphone agent)"

	help
	{
		"Sequence of operations to compute Reporting Requirements num. 6 (the total number of hits to O2 lower level bookmark and with iphone agent)"
	}

	code
	{
		clear $2;
		clear $3;
		
		osn.parse_urls $1 $1.parse -clear -create;
		set osn.user_agent_query iphone;
		set osn.locDoc_query o2.co.uk;
		osn.map_url_user $1.parse $1.p.map $1.total -clear -create;
		osn.red_compute_total_and_set $1.total -clear -create;
		osn.red_compute_sites_visited $1.p.map $1.p.m.red -clear -create;
		osn.export_report $1.p.m.red $2 -clear -create;
		#download $1.p.m.red.txt $2;
		osn.red_compute_total_elements $1.p.m.red $1.p.m.red.total -clear -create;
		#osn.export_total $1.p.m.red.total $3 -clear -create;
		#download $1.p.m.red.total.txt $3;
	}
}

script Bytemobile_req_7
{
	in 	txt txt
	out	txt txt
	out	txt txt

	helpLine "Sequence of operations to compute Reporting Requirements num. 7 (penetration of apps (stocks, weather, maps, iTunes)"

	help
	{
		"Sequence of operations to compute Reporting Requirements num. 7 (penetration of apps (stocks, weather, maps, iTunes)"
	}

	code
	{
		clear $2;
		clear $3;
		
		osn.parse_urls $1 $1.parse -clear -create;
		set osn.user_agent_query iphone;
		set osn.locDoc_query o2.co.uk;
		osn.map_applications $1.parse $1.p.agentmap $1.p.map $1.total -clear -create;
		osn.red_compute_total_and_set $1.total -clear -create;
		osn.red_compute_sites_visited $1.p.map $1.p.m.red -clear -create;
		osn.export_report $1.p.m.red $2 -clear -create;
		osn.red_compute_sites_visited $1.p.agentmap $1.p.am.red -clear -create;
		osn.export_report $1.p.am.red $1.p.am.red.txt -clear -create;
		#download $1.p.m.red.txt $2;
		osn.red_compute_total_elements $1.p.m.red $1.p.m.red.total -clear -create;
		#osn.export_total $1.p.m.red.total $3 -clear -create;
		#download $1.p.m.red.total.txt $3;
	}
}
