/*
 * Telefónica Digital - Product Development and Innovation
 *
 * THIS CODE AND INFORMATION ARE PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND,
 * EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.
 *
 * Copyright (c) Telefónica Investigación y Desarrollo S.A.U.
 * All rights reserved.
 */

/**
 File autogenerated with samsonModuleParser. Please, edit to complete this operation
*/

#ifndef _H_SAMSON_cdr_sna_remove_duplicated_cdrs
#define _H_SAMSON_cdr_sna_remove_duplicated_cdrs


#include <samson/module/samson.h>


namespace samson{
namespace cdr{


	class remove_duplicated_cdrs : public samson::Reduce
	{

		samson::system::UInt node;
		samson::cdr::CDR cdr1;
		samson::cdr::CDR cdr2;
		
		samson::cdr::CDR *current_CDR;
		samson::cdr::CDR *previous_CDR;	
		
	public:


		void run(  samson::KVSetStruct* inputs , samson::KVWriter *writer )
		{
			
			if( inputs[0].num_kvs == 0)
				return;
			
			//Parse and emit the first one...
			node.parse(inputs[0].kvs[0]->key );
			cdr1.parse( inputs[0].kvs[0]->value );
			writer->emit(0,&node, &cdr1);	
			
			
			if( inputs[0].num_kvs < 2)	//One is never repeated
				return;
			
			current_CDR		= &cdr2;
			previous_CDR	= &cdr1;
			
			for (size_t i=1 ; i < inputs[0].num_kvs ; i++)
			{
				current_CDR->parse(inputs[0].kvs[i]->value);
				
				//Compare with the previous one
				if(  *current_CDR != *previous_CDR )
					writer->emit( 0 , &node, current_CDR);
				
				//Exchange of pointers
				samson::cdr::CDR *tmp = current_CDR;
				current_CDR = previous_CDR;
				previous_CDR = tmp;
			}			
		}


	};


} // end of namespace samson
} // end of namespace cdr

#endif
