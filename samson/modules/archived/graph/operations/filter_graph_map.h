/*
 * Telefónica Digital - Product Development and Innovation
 *
 * THIS CODE AND INFORMATION ARE PROVIDED "AS IS" WITHOUT WARRANTY OF ANY KIND,
 * EITHER EXPRESSED OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND/OR FITNESS FOR A PARTICULAR PURPOSE.
 *
 * Copyright (c) Telefónica Investigación y Desarrollo S.A.U.
 * All rights reserved.
 */

/**
 File autogenerated with samsonModuleParser. Please, edit to complete this operation
*/

#ifndef _H_SAMSON_graph_filter_graph_map
#define _H_SAMSON_graph_filter_graph_map

#include <samson/module/samson.h>
#include <samson/modules/system/UInt.h>
#include "samson/modules/graph/Node.h"
#include <assert.h>

namespace samson{
namespace graph{


	class filter_graph_map : public samson::Map
	{

		samson::system::UInt killNode_id;
		samson::graph::Node killNode;
		
		//Inputs
		samson::system::UInt  node_id;
		samson::graph::Node node;
		
	public:

		void run(  samson::KVSetStruct* inputs , samson::KVWriter *writer )
		{
			int max_strong_connections	= environment->getInt( "graph.max_strong_connections" ,  50 );
			int max_connections			= environment->getInt( "graph.max_connections" ,  400 );
			
			killNode.linksSetLength(0);	//A node with no links will be identified as a mark to be removed
			
			for (size_t i = 0 ; i < inputs[0].num_kvs ; i++)
			{
				//Parsing key and value
				node_id.parse( inputs[0].kvs[i]->key );
				node.parse( inputs[0].kvs[i]->value );

				if( node.links_length == 0)
				{
				   OLM_E(("Node with 0 contacts ( %lu )" , node_id.value )); 
				}
				
				
				if( node_id.value != node.id.value )
				   tracer->setUserError("Graph not correctly formed. key and value are not related");

				if (
					(  node.numberOfLinksWithWeightEqualOrHigher( 1.0 ) > max_strong_connections ) ||
					(  node.numberOfLinksWithWeightEqualOrHigher( 0.0 ) > max_connections )
					)
				{
					//Emit kill messages to be removed in all the contrpart nodes in the reduce fase
					
					killNode.id = node_id.value ;	
					for (int j = 0 ; j < node.links_length ; j++)
					{
						killNode_id.value = node.links[j].id.value;		//This is the target node to be removed in

						if( killNode_id.value == node.id.value )
						{
						   OLM_W(("Node %lu is connected to itself... not sending a kill my-self message" , node.id.value ));
						}
						else
						   writer->emit( 0 , &killNode_id, &killNode );
					}
				}
				else
				{
					//Simply by pass the map to the reduce
					writer->emit(0,&node_id, &node);
				}
			}			
		}


	};


} // end of namespace samson
} // end of namespace graph

#endif
